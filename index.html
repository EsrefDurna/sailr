<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
	<title>Sailr</title>
	<script type="text/javascript" src="js/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });

var cursors;
var boat;

var acceleration = 200;
var drag = 0;
var maxspeed = 400;
var status = 0;

var statusText;

function preload() {
//    console.log('preload');
	game.load.image('boat', '/img/boat.png');
    game.load.image('compass', '/img/compass.png');
    game.scale.pageAlignHorizontally = true;
    game.scale.pageAlignVertically = true;

    game.physics.startSystem(Phaser.Physics.ARCADE);

    game.world.setBounds(0, 0, 800, 600);
}

function create() {
    //white background
    game.stage.backgroundColor = "#1C6BA0";

    //THE BOAT
	boat = game.add.sprite(100,100, 'boat');
    //anchor from middle
    boat.anchor.setTo(0.5);
    //it's a big img
    boat.scale.x = 0.15;
    boat.scale.y = 0.15;
    game.physics.enable(boat, Phaser.Physics.ARCADE);
    boat.body.maxVelocity.setTo(maxspeed);
    boat.body.drag.setTo(drag,drag);
    boat.body.collideWorldBounds = true;

    boat.body.angularDrag = 20;
//    boat.body.velocity.set(10,0);

    var style = { font: "18px Arial", fill: "#000", align: "right" };
    statusText = game.add.text(game.width-100, 50, "", style);
    statusText.anchor.x = Math.round(statusText.width * 0.5) / statusText.width;
    statusText.fixedToCamera = true;

    var compass = game.add.sprite(0,0, 'compass');
    compass.scale.x = 0.15;
    compass.scale.y = 0.15;

    cursors = game.input.keyboard.createCursorKeys();

}

var rudderAcceleration = 30;
var boatSpeed = 30;
function update() {


    boat.body.angularAcceleration = 0;


    //rotate the boat to the velocity angle
//    boat.body.rotation = radsToDegrees(boat.body.angle) + 90;

    //since we're not powered, maybe I should only affect angular acceleration
    if(cursors.left.isDown) {
        boat.body.angularAcceleration = -rudderAcceleration;
    } else if(cursors.right.isDown) {
        boat.body.angularAcceleration = rudderAcceleration;
    }

    //    boat.body.acceleration.x = 0;
//    boat.body.acceleration.y = 0;

    //boat is moving at speed in direction of its heading

    //have the angle and the direction
    // so cos( heading )



    boat.body.velocity.y = -Math.cos( Phaser.Math.degToRad( boat.body.rotation ) ) * boatSpeed;
    boat.body.velocity.x = Math.sin( Phaser.Math.degToRad( boat.body.rotation ) )* boatSpeed;




//    if(cursors.up.isDown) {
//        boat.body.acceleration = acceleration;
//    } else if(cursors.down.isDown) {
//        boat.body.acceleration = -acceleration;
//    }



    var heading = compassAngle(Math.round(boat.body.rotation));
    statusText.text =
            "velX: " + Math.round(boat.body.velocity.x) +
            "\nvelY: " + Math.round(boat.body.velocity.y) +
            "\nheading: " + heading +
            "\nWind: " + wind.getSpeed() + "kts @ " + wind.getDirection() +
            "\nAngle: " + wind.getBearingRelativeTo(heading) +
            "\n" + pointOfSail(wind.getBearingRelativeTo(heading)).toString()
            + "\nangularV: " + Math.round(boat.body.angularVelocity)
            + "\nangularA: " + Math.round(boat.body.angularAcceleration)
    ;

    ;
}

function radsToDegrees(radians) {
    return radians*180/Math.PI;
}
function compassAngle(degrees) {
    var angle = degrees;
    if(angle < 0)
        angle += 360;
    else if(angle >= 360)
        angle -= 360;
    return angle;
}

var wind = {
    getSpeed: function() {
        return 10;
    },
    getDirection: function() {
        return 0;
    },
    getBearingRelativeTo: function(compassBearing) {
        var diff = compassBearing - this.getDirection();
        return diff < 180 ? diff : 360 - diff; //returns values between 0 and 180
    }
};
//could each have a function to take boat & wind, check characteristics and determine boat speed. Sail inventory, hull & keel features
//we;ll do 180/5 = 36 for ease of use now. America's cup boat angles
var pointsOfSail = [
    {
        toString: function() { return "Irons"; },
        check: function(bearing) {
            return Math.abs(bearing) < 36;
        }
    },
    {
        toString: function() { return "Close Hauled"; },
        check: function(bearing) {
            var absoluteBearing = Math.abs(bearing);
            return absoluteBearing >= 36 && absoluteBearing < 72;
        }
    },
    {
        toString: function() { return "Beam Reaching"; },
        check: function(bearing) {
            var absoluteBearing = Math.abs(bearing);
            return absoluteBearing >= 72  && absoluteBearing < 108;
        }
    },
    {
        toString: function() { return "Reaching"; },
        check: function(bearing) {
            var absoluteBearing = Math.abs(bearing);
            return absoluteBearing >= 108  && absoluteBearing < 144;
        }
    },
    {
        toString: function() { return "Downwind"; },
        check: function(bearing) {
            var absoluteBearing = Math.abs(bearing);
            return absoluteBearing >= 144  ;
        }
    }
];

function pointOfSail(bearingFromWind) {
    for(var i=0;i<pointsOfSail.length;i++) {
        if(pointsOfSail[i].check(bearingFromWind))
            return pointsOfSail[i];
    }
}
//
//var windAngle = wind.getBearingRelativeTo(boat.getBearing());
//
//
//function printStatus() {
//    console.log("Heading: " + boat.getBearing() );
//    console.log("Wind:    " + wind.getSpeed() + "kts @ " + wind.getDirection() );
//    console.log(pointOfSail(windAngle).toString() + " (" + windAngle + ")");
//}
//
//printStatus();

</script>

</body>
</html>