<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
	<title>Sailr</title>
	<script type="text/javascript" src="js/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });

//todo variable organization
var cursors;

var boat;
var windSprite;

var acceleration = 200;
var drag = 0;
var maxspeed = 400;

var boatSpeed = 80;
//steering feel
var rudderAcceleration = 200;
var angularDrag = 200;  //maybe should be a function increasing with speed!
var maxAngular = 80;

var status = 0;

var statusText;

function preload() {
//    console.log('preload');
	game.load.image('boat', 'img/boatSmall.png');
    game.load.image('compass', 'img/compass.png');
    game.load.image('wind', 'img/wind200.png');
    game.scale.pageAlignHorizontally = true;
    game.scale.pageAlignVertically = true;

    game.physics.startSystem(Phaser.Physics.ARCADE);

    game.world.setBounds(0, 0, 800, 600);
}

function create() {
    //white background
    game.stage.backgroundColor = "#1C6BA0";

    //THE BOAT
	boat = game.add.sprite(100,100, 'boat');
    //anchor from middle
    boat.anchor.setTo(0.5);
    //it's a big img
    boat.scale.x = 0.5;
    boat.scale.y = 0.5;
    game.physics.enable(boat, Phaser.Physics.ARCADE);
    boat.body.maxVelocity.setTo(maxspeed);
    boat.body.maxAngular = maxAngular;
    boat.body.drag.setTo(drag,drag);
    boat.body.collideWorldBounds = true;
    //simulate rudder steering, when at speed it will return to center
    boat.body.angularDrag = angularDrag;
    boat.rotation = 2;

    var style = { font: "18px Arial", fill: "#000", align: "right" };
    statusText = game.add.text(game.width-150, 30, "", style);
//    statusText.anchor.x = Math.round(statusText.width * 0.5) / statusText.width;
    statusText.fixedToCamera = true;

    var directions = { font: "18px Arial", fill: "#000" };
    var directionText = game.add.text(300, 10, "Use the left and right arrows to move your rudder", style);


    var compass = game.add.sprite(0,0, 'compass');
    compass.scale.setTo(0.15);

    windSprite = game.add.sprite(400,10,'wind');
    windSprite.anchor.setTo(0.5);
    windSprite.scale.setTo(0.4);
    windSprite.rotation = Phaser.Math.degToRad( wind.direction + 180 );
    wind.lastShift = Date.now();

    cursors = game.input.keyboard.createCursorKeys();
}

var wind_shift_period = 3*1000;
var wind_shift_chance = 0.5;
var wind_shift_range = 20;

function update() {
    if( wind_shift_period < (Date.now() - wind.lastShift) ) {
        if( Math.random() < wind_shift_chance ) {
        wind.setDirection(
                //if the wind shift range is 45,the wind will shift up to +/- 22.5 degrees on either side
                wind.direction + (wind_shift_range * Math.random()) - (wind_shift_range/2));
        } else {
            wind.lastShift = Date.now(); //delay the shift
        }
    }
    //update wind indicator
    windSprite.rotation =  Phaser.Math.degToRad( wind.direction + 90 );

    //rudder alters the angular acceleration of the boat
    boat.body.angularAcceleration = 0;
    if(cursors.left.isDown) {
        boat.body.angularAcceleration = -rudderAcceleration;
    } else if(cursors.right.isDown) {
        boat.body.angularAcceleration = rudderAcceleration;
    }

    //Move boat at a constant speed in the direction it is pointing (body.rotation)
    boat.body.velocity.y = -Math.cos( Phaser.Math.degToRad( boat.body.rotation ) ) * boatSpeed;
    boat.body.velocity.x = Math.sin( Phaser.Math.degToRad( boat.body.rotation ) )* boatSpeed;

//    if(cursors.up.isDown) {
//        boat.body.acceleration = acceleration;
//    } else if(cursors.down.isDown) {
//        boat.body.acceleration = -acceleration;
//    }
    var heading = compassAngle( Math.round(boat.body.rotation) ); //rotation is 90 degrees different then the game plane
//    console.log(heading);
    statusText.text =
            "velX: " + Math.round(boat.body.velocity.x) +
            "\nvelY: " + Math.round(boat.body.velocity.y) +
            "\nheading: " + heading +
            "\nWind: " + Math.round(wind.speed) + "kts @ " + Math.round(compassAngle(wind.direction)) +
            "\nAngle: " + Math.round(wind.getBearingRelativeTo(heading)) +
            "\n" + pointOfSail(wind.getBearingRelativeTo(heading)).name
//            + "\nangularV: " + Math.round(boat.body.angularVelocity)
//            + "\nangularA: " + Math.round(boat.body.angularAcceleration)
//            + "\nnow: " + Date.now()
    ;

    //update
}

function radsToDegrees(radians) {
    return radians*180/Math.PI;
}
function compassAngle(degrees) {
    var angle = degrees;
    if(angle < 0)
        angle += 360;
    else if(angle >= 360)
        angle -= 360;
    return angle;
}

var wind = {
    speed: 10,
    direction: 0,
    lastShift: 0,
    setDirection: function(direction) {
        this.lastShift = Date.now();
        this.direction = direction;
    },
    getBearingRelativeTo: function(compassBearing) {
        var diff = Math.abs(compassBearing - this.direction);
        return diff < 180 ? diff : 360 - diff; //returns values between 0 and 180
    }
};

function pointOfSail(bearingFromWind) {
    var bearing = Math.floor(bearingFromWind);
    if( bearing <= 35 ) {//america's cup angles
        return {
            name: "In Irons",
            maxSpeedFactor: -0.2,
            accelerationFactor: 1
        }
    } else if( bearing >= 36 && bearing <= 72 ) {
        return {
            name: "Close Hauled",
            maxSpeedFactor: 0.6,
            accelerationFactor: 0.6
        }
    } else if(  bearing >= 73 && bearing <= 108 ) {
        return {
            name: "Beam Reaching",
            maxSpeedFactor: 0.75,
            accelerationFactor: 0.75
        }
    } else if( bearing >= 109 && bearing <=144) {
        return {
            name: "Reaching",
            maxSpeedFactor: 1,
            accelerationFactor: 1
        }
    } else if( bearing >=145 ) {
        return {
            name: "Downwind",
            maxSpeedFactor: 0.9,
            accelerationFactor: 1
        }
    }
}

</script>

</body>
</html>